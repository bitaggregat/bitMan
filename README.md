# bitMan

The bitMan is a versatile, strictly limited edition DIY gadget that combines the Christmas season with technology and creativity. With features such as individually controllable LEDs, melodies and programmability, it is ideal for hobbyists and technology enthusiasts - from beginners to experienced developers. Thanks to the USB-C connection and an Arduino-compatible microcontroller, there are virtually no limits to your projects.

## Hardware

### Pin Assignments

| Component         |               Direction | PORT - PIN | Arduino-PIN |                      Comment |
|:------------------|------------------------:|-----------:|------------:|-----------------------------:|
| ATmega328PB       |                       - |          - |           - | With Micronucleus bootloader |
| Led 1 (red)       |                    GPIO |     PD5    |             |      Low-Active (VCC driven) |
| Led 3 (red)       |                    GPIO |     PC0    |             |      Low-Active (VCC driven) |
| Led 4 (red)       |                    GPIO |     PD1    |             |      Low-Active (VCC driven) |
| Led 5 (green)     |                    GPIO |     PB6    |             |     High-Active (MCU driven) |
| Led 6 (green)     |                    GPIO |     PB7    |             |     High-Active (MCU driven) |
| RGB LED 2 (blue)  |                    GPIO |     PB2    |             |     High-Active (MCU driven) |
| RGB LED 2 (red)   |                    GPIO |     PB1    |             |     High-Active (MCU driven) |
| RGB LED 2 (green) |                    GPIO |     PD6    |             |     High-Active (MCU driven) |
| Buzzer            |                    GPIO |     PD2    |             |     High-Active (MCU driven) |
| Button            |                    GPIO |     PC1    |             |                            - |
| Grove Adapter     | I²C/GPIO (only digital) |     PE0    |             |                            - |
| Grove Adapter     | I²C/GPIO (only digital) |     PE1    |             |                            - |
| SPI-Reset         |              Reset/GPIO |     PC6    |             |                            - |
| SPI-CIPO (MISO)   |                     SPI |     PB4    |             |                            - |
| SPI-COPI (MOSI)   |                     SPI |     PB3    |             |                            - |
| SPI-Clock         |                     SPI |     PB5    |             |                            - |
| USB D+            |                    GPIO |     PB3    |             |                            - |
| USB D-            |                    GPIO |     PB4    |             |                            - |


### Schematic and project files

The [schematic](./hardware/bitMan-Schematic.pdf) and the project files are located in the *hardware*-subdirectory. For additional information refer to the [Hardware README.md](./hardware/README.md).

## Updating the bitMan application

It is not yet possible to flash the application directly from the Arduino IDE. Therefore you have to install the tool [micronucleus commandline tool](https://github.com/micronucleus/micronucleus/tree/master/commandline) and use it as follows:

1. **Disconnect** the USB cable from the bitMan
2. Select the **Arduino Uno** as project board in the Arduino IDE
3. Export the project from the Arduino IDE: Menu “Sketch” -> “Export Compiled Binary”
4. Execute the following command in a console to **flash** the exported hex-file `micronucleus --run <path_to_repo>/bitMan/software/bitBreadMan/build/arduino.avr.uno/bitBreadMan.ino.hex`
5. **Connect** the USB cable to the bitMan (important: the above command must be started beforehand, as the tool is waiting for the bootloader)

What happens here in the background: As soon as the bitMan is supplied with power, the bootloader (micronucleus) starts. If there is no communication between the bitdMan and the host (PC) within 2s, the flashed application starts, if a valid one is available.
The bootloader registers a USB device in the host, with which the “micronucleus commandline tool” communicates and can manipulate the flash in the bitMan.

## Build and install the bootloader

It is only required to build and update/install the bootloader, if you got a PCB directly from the assembly line. Refer to the [bootloader README](./software/bootloader/README.md) for some first instructions.

You also can use the hardware without the bootloader, but then you always have to program it with an external programmer. It is not possible to program the application through USB without the bootloader.

## Customize bitMan

The application code of the bitMan can be found in the source file [bitMan.ino](./software/bitMan/bitMan.ino) - this is where the states of the 6 red LEDs, the RGB star and the piezo buzzer are controlled.

### Implement new song

The song generated by the piezo buzzer can be changed by including a different, structurally identical header file instead of [jingle_bells.h](./software/bitMan/songs/jingle_bells.h).
This must contain a list `note song[]` of the consecutive notes and their note lengths.

### Adjusting the color of the star's RGB LED

The behavior of the RGB star is defined in thread 2.
The color of the RGB LED can be adjusted by changing the red, green and blue values in `enable_rgb_led()`.

### Change the flashing pattern of the red LEDs

The “random” flashing of the red LEDs is defined in thread 3.
Individual LEDs can be activated/deactivated by `enable_led()`.

### Use the Grove ecosystem

Thanks to the integrated Grove connection, the bitMan can be expanded with Grove modules such as sensors or network modules. Further information and examples can be found [here](https://wiki.seeedstudio.com/Grove_System/).

